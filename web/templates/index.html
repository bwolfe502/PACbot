{% extends "base.html" %}
{% block title_suffix %} - Dashboard{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<div class="summary-bar">
    <span class="badge">{{ devices|length }} device{{ 's' if devices|length != 1 }}</span>
    <span class="badge {% if task_count > 0 %}badge-active{% endif %}">{{ task_count }} task{{ 's' if task_count != 1 }} running</span>
</div>

{% if not devices %}
<div class="card">
    <p class="muted">No devices found. Start your emulator and refresh.</p>
    <form method="post" action="/api/devices/refresh">
        <button type="submit" class="btn">Refresh Devices</button>
    </form>
</div>
{% endif %}

{% for dev in devices %}
<div class="card device-card" data-device="{{ dev.id }}">
    <div class="device-header">
        <strong>{{ dev.name }}</strong>
        <span class="device-troops">{{ dev.troops }} troops</span>
    </div>
    <div class="device-status {% if dev.status != 'Idle' %}status-active{% endif %}">
        {{ dev.status }}
    </div>
    <div class="troop-slots"></div>
    <div class="quest-tracking"></div>
</div>
{% endfor %}

{% if tasks %}
<h2>Running Tasks</h2>
{% for task in tasks %}
<div class="card task-card">
    <span class="task-name">{{ task }}</span>
    <form method="post" action="/tasks/stop" style="display:inline">
        <input type="hidden" name="task_key" value="{{ task }}">
        <button type="submit" class="btn btn-stop btn-sm">Stop</button>
    </form>
</div>
{% endfor %}
<form method="post" action="/tasks/stop-all">
    <button type="submit" class="btn btn-danger">Stop All Tasks</button>
</form>
{% endif %}

<div class="quick-actions">
    <a href="/tasks" class="btn btn-primary">Start Tasks</a>
    <form method="post" action="/api/devices/refresh" style="display:inline">
        <button type="submit" class="btn">Refresh Devices</button>
    </form>
</div>

<div class="quick-actions" style="margin-top:8px">
    <button type="button" class="btn btn-danger" id="restart-btn" onclick="confirmRestart()">Restart PACbot</button>
</div>
{% endblock %}

{% block scripts %}
<script>
function fmtTime(sec) {
    if (sec == null) return '';
    var m = Math.floor(sec / 60), s = sec % 60;
    return m + ':' + (s < 10 ? '0' : '') + s;
}

function renderTroops(container, troops, age) {
    if (!troops || troops.length === 0) {
        container.innerHTML = '<span class="muted" style="font-size:12px">No troop data yet</span>';
        return;
    }
    var html = '';
    troops.forEach(function(t) {
        var isHome = t.action === 'Home';
        var cls = isHome ? 'troop-home' : 'troop-deployed';
        var label = t.action;
        if (!isHome && t.time_left != null) {
            label += ' ' + fmtTime(t.time_left);
        }
        html += '<span class="troop-slot ' + cls + '">' + label + '</span>';
    });
    if (age != null) {
        html += '<span class="troop-age">' + (age < 60 ? age + 's ago' : Math.floor(age/60) + 'm ago') + '</span>';
    }
    container.innerHTML = html;
}

function renderQuests(container, quests) {
    if (!quests || quests.length === 0) {
        container.innerHTML = '';
        return;
    }
    var html = '';
    quests.forEach(function(q) {
        var type = q.quest_type.replace('QuestType.', '');
        var seen = q.last_seen != null ? q.last_seen : '?';
        var pend = q.pending > 0
            ? ' <span class="quest-pending">+' + q.pending + ' pending</span>'
            : '';
        html += '<div class="quest-row">'
            + '<span class="quest-type">' + type + '</span>'
            + '<span class="quest-count">' + seen + pend + '</span>'
            + '</div>';
    });
    container.innerHTML = html;
}

function refreshStatus() {
    fetch('/api/status')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (!data.devices) return;
            data.devices.forEach(function(dev) {
                var card = document.querySelector('.device-card[data-device="' + dev.id + '"]');
                if (!card) return;
                // Status text
                var status = card.querySelector('.device-status');
                if (status) {
                    status.textContent = dev.status;
                    if (dev.status !== 'Idle') {
                        status.classList.add('status-active');
                    } else {
                        status.classList.remove('status-active');
                    }
                }
                // Troop slots
                var troopEl = card.querySelector('.troop-slots');
                if (troopEl) renderTroops(troopEl, dev.troops, dev.snapshot_age);
                // Quest tracking
                var questEl = card.querySelector('.quest-tracking');
                if (questEl) renderQuests(questEl, dev.quests);
            });
            // Update task count badge
            var badges = document.querySelectorAll('.badge');
            if (badges.length > 1) {
                var count = data.tasks ? data.tasks.length : 0;
                badges[1].textContent = count + ' task' + (count !== 1 ? 's' : '') + ' running';
                if (count > 0) {
                    badges[1].classList.add('badge-active');
                } else {
                    badges[1].classList.remove('badge-active');
                }
            }
        })
        .catch(function() {});
}

refreshStatus();
setInterval(refreshStatus, 3000);

function confirmRestart() {
    if (!confirm('Restart PACbot? All running tasks will be stopped.')) return;
    var btn = document.getElementById('restart-btn');
    btn.disabled = true;
    btn.textContent = 'Restarting...';
    fetch('/api/restart', {method: 'POST'}).catch(function() {});
    // Poll until the server is back up, then reload
    function waitForServer() {
        fetch('/api/status')
            .then(function(r) {
                if (r.ok) location.reload();
                else setTimeout(waitForServer, 1000);
            })
            .catch(function() { setTimeout(waitForServer, 1000); });
    }
    setTimeout(waitForServer, 2000);
}
</script>
{% endblock %}
