{% extends "base.html" %}
{% block title_suffix %} - Dashboard{% endblock %}

{% block content %}

<!-- Access -->
{% if relay_url %}
<div class="access-card">
    <span class="access-icon">&#128241;</span>
    <div class="access-info">
        <span class="access-label">Remote Access</span>
        <span class="access-status">
            <span class="tunnel-dot tunnel-connecting" id="access-dot"></span>
            <span class="tunnel-label tunnel-label-connecting" id="access-status-text">Connecting...</span>
        </span>
    </div>
    <div class="access-actions">
        <button type="button" class="access-btn" onclick="copyAccessUrl(this, '{{ relay_url }}')" title="Copy URL">Copy</button>
        <button type="button" class="access-btn" onclick="showQr('{{ relay_url }}')" title="QR Code">QR</button>
    </div>
</div>
{% else %}
<div class="access-card">
    <span class="access-icon">&#128241;</span>
    <div class="access-info">
        <span class="access-label">Local Network</span>
    </div>
    <div class="access-actions">
        <button type="button" class="access-btn" onclick="copyAccessUrl(this, 'http://{{ local_ip }}:8080')" title="Copy URL">Copy</button>
        <button type="button" class="access-btn" onclick="showQr('http://{{ local_ip }}:8080')" title="QR Code">QR</button>
    </div>
</div>
{% endif %}

<!-- QR Code Modal -->
<div class="qr-overlay" id="qr-overlay" onclick="closeQr()">
    <div class="qr-modal" onclick="event.stopPropagation()">
        <div class="qr-title" id="qr-title"></div>
        <img class="qr-img" id="qr-img" alt="QR Code">
        <button type="button" class="qr-close" onclick="closeQr()">Close</button>
    </div>
</div>

<!-- Device Cards -->
{% if not devices %}
<div class="card">
    <p class="muted">No devices found. Start your emulator and refresh.</p>
    <form method="post" action="/api/devices/refresh">
        <button type="submit" class="btn">Refresh Devices</button>
    </form>
</div>
{% endif %}

{% for dev in devices %}
<div class="card device-card" data-device="{{ dev.id }}">
    <div class="device-header">
        <strong>{{ dev.name }}</strong>
        <span class="device-troops">{{ dev.troops }} troops</span>
    </div>
    <div class="device-status-bar">
        <span class="status-indicator {% if dev.status != 'Idle' %}active{% endif %}"></span>
        <span class="status-text">{{ dev.status }}</span>
    </div>
    <div class="section-label">Troops</div>
    <div class="troop-slots"></div>
    <div class="section-label quest-header" style="display:none">Quests</div>
    <div class="quest-tracking"></div>
</div>
{% endfor %}

<!-- Device Selector (multi-device) -->
{% if devices|length > 1 %}
<div class="card" style="padding:12px 16px">
    <div class="device-select">
        {% for dev in devices %}
        <label class="device-option">
            <input type="checkbox" name="device_select" value="{{ dev.id }}"
                   checked
                   onchange="updateDeviceForms()">
            {{ dev.name }}
        </label>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Auto Modes -->
<div class="auto-columns">
{% for group in auto_groups %}
<div class="auto-column">
    <div class="section-header">{{ group.group }}</div>
    <div class="auto-list">
    {% for mode in group.modes %}
        {% set mode_running = [] %}{% for t in active_tasks %}{% if t.endswith('_' + mode.key) %}{% if mode_running.append(t) %}{% endif %}{% endif %}{% endfor %}
        <div class="auto-row" data-mode="{{ mode.key }}">
            <span class="auto-label">{{ mode.label }}</span>
            <button type="button" class="toggle{% if mode_running %} on{% endif %}"
                    onclick="toggleAutoMode('{{ mode.key }}')"
                    title="{{ mode.label }}"></button>
        </div>
    {% endfor %}
    </div>
</div>
{% endfor %}
</div>

<!-- Quick Actions -->
<div class="section-header" style="margin-top:24px">Actions</div>
<div class="action-grid">
{% for name in oneshot_farm %}
<form method="post" action="/tasks/start" class="device-form">
    <input type="hidden" name="device" value="{% if devices %}{{ devices[0].id }}{% endif %}">
    <input type="hidden" name="task_name" value="{{ name }}">
    <input type="hidden" name="task_type" value="oneshot">
    <button type="submit" class="action-chip">{{ name }}</button>
</form>
{% endfor %}
{% for name in oneshot_war %}
<form method="post" action="/tasks/start" class="device-form">
    <input type="hidden" name="device" value="{% if devices %}{{ devices[0].id }}{% endif %}">
    <input type="hidden" name="task_name" value="{{ name }}">
    <input type="hidden" name="task_type" value="oneshot">
    <button type="submit" class="action-chip action-chip-war">{{ name }}</button>
</form>
{% endfor %}
</div>

<!-- Running Tasks -->
{% if tasks %}
<div class="section-header" style="margin-top:24px">Running</div>
<div class="running-list">
{% for task in tasks %}
<div class="running-row">
    <span class="running-name">{{ task }}</span>
    <form method="post" action="/tasks/stop" class="inline-form">
        <input type="hidden" name="task_key" value="{{ task }}">
        <button type="submit" class="running-stop">&times;</button>
    </form>
</div>
{% endfor %}
</div>
{% endif %}

<!-- Bottom -->
<div class="bottom-bar">
    <form method="post" action="/tasks/stop-all" style="flex:1">
        <button type="submit" class="bottom-btn bottom-btn-danger">Stop All</button>
    </form>
    <form method="post" action="/api/devices/refresh" style="flex:1">
        <button type="submit" class="bottom-btn">Refresh</button>
    </form>
    <button type="button" class="bottom-btn" style="flex:1" onclick="downloadBugReport()">Bug Report</button>
</div>

{% endblock %}

{% block scripts %}
<script>
// Per-device troop data for client-side countdown between polls
var _troopData = {};

function renderTroops(container, troops, age, elapsed) {
    container.textContent = '';
    if (!troops || troops.length === 0) {
        var hint = document.createElement('span');
        hint.className = 'muted';
        hint.style.fontSize = '11px';
        hint.textContent = 'No troop data yet';
        container.appendChild(hint);
        return;
    }
    troops.forEach(function(t) {
        var isHome = t.action === 'Home';
        var cls = ACTION_CLASSES[t.action] || 'troop-deployed';
        var label = t.action;
        if (!isHome && t.time_left != null) {
            var adjusted = Math.max(0, t.time_left - (elapsed || 0));
            label += ' ' + fmtTime(adjusted);
        }
        var span = document.createElement('span');
        span.className = 'troop-slot ' + cls;
        span.textContent = label;
        container.appendChild(span);
    });
    if (age != null) {
        var displayAge = age + (elapsed || 0);
        var ageSpan = document.createElement('span');
        ageSpan.className = 'troop-age';
        ageSpan.textContent = displayAge < 60 ? displayAge + 's ago' : Math.floor(displayAge/60) + 'm ago';
        container.appendChild(ageSpan);
    }
}

function tickTroopTimers() {
    var now = Date.now();
    Object.keys(_troopData).forEach(function(deviceId) {
        var entry = _troopData[deviceId];
        var elapsed = Math.floor((now - entry.lastPollTime) / 1000);
        if (elapsed < 1) return;
        var card = document.querySelector('.device-card[data-device="' + deviceId + '"]');
        if (!card) return;
        var troopEl = card.querySelector('.troop-slots');
        if (troopEl) renderTroops(troopEl, entry.troops, entry.snapshotAge, elapsed);
    });
}
setInterval(tickTroopTimers, 1000);

function fmtNum(n) {
    if (n == null) return '?';
    return n.toLocaleString();
}

function renderQuests(container, quests) {
    var header = container.previousElementSibling;
    if (!quests || quests.length === 0) {
        container.textContent = '';
        if (header) header.style.display = 'none';
        return;
    }
    if (header) header.style.display = '';
    container.textContent = '';
    var wrap = document.createElement('div');
    wrap.className = 'dp-quests';
    quests.forEach(function(q) {
        var raw = q.quest_type.replace('QuestType.', '');
        var label = QUEST_LABELS[raw] || raw;
        var seen = q.last_seen != null ? q.last_seen : 0;
        var target = q.target;
        var pend = q.pending || 0;
        if (target != null && seen >= target && pend === 0) return;
        var pill = document.createElement('div');
        pill.className = 'quest-pill';
        var lbl = document.createElement('span');
        lbl.className = 'quest-label';
        lbl.textContent = label;
        pill.appendChild(lbl);
        var val = document.createElement('span');
        val.className = 'quest-val';
        var valText = fmtNum(seen);
        if (target != null) valText += '/' + fmtNum(target);
        val.textContent = valText;
        if (pend > 0) {
            var pendSpan = document.createElement('span');
            pendSpan.className = 'quest-pend';
            pendSpan.textContent = '+' + pend;
            val.appendChild(pendSpan);
        }
        pill.appendChild(val);
        wrap.appendChild(pill);
    });
    container.appendChild(wrap);
}

function refreshStatus() {
    fetch('/api/status')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (!data.devices) return;
            data.devices.forEach(function(dev) {
                var card = document.querySelector('.device-card[data-device="' + dev.id + '"]');
                if (!card) return;
                var statusBar = card.querySelector('.device-status-bar');
                if (statusBar) {
                    var dot = statusBar.querySelector('.status-indicator');
                    var text = statusBar.querySelector('.status-text');
                    if (text) {
                        text.textContent = dev.status;
                        text.classList.remove('status-active', 'status-waiting', 'status-navigating');
                        if (dev.status === 'Idle') {
                            // default gray
                        } else if (dev.status.indexOf('Waiting') !== -1) {
                            text.classList.add('status-waiting');
                        } else if (dev.status.indexOf('Navigating') !== -1) {
                            text.classList.add('status-navigating');
                        } else {
                            text.classList.add('status-active');
                        }
                    }
                    if (dot) {
                        if (dev.status !== 'Idle') dot.classList.add('active');
                        else dot.classList.remove('active');
                    }
                }
                var troopEl = card.querySelector('.troop-slots');
                if (troopEl) {
                    _troopData[dev.id] = {
                        troops: dev.troops,
                        snapshotAge: dev.snapshot_age,
                        lastPollTime: Date.now()
                    };
                    renderTroops(troopEl, dev.troops, dev.snapshot_age, 0);
                }
                var questEl = card.querySelector('.quest-tracking');
                if (questEl) renderQuests(questEl, dev.quests);
            });
            // Update tunnel status
            var dot = document.getElementById('access-dot');
            var lbl = document.getElementById('access-status-text');
            if (dot && data.tunnel) {
                var labels = {connected:'Connected', connecting:'Connecting...', disconnected:'Disconnected', disabled:'Disabled'};
                dot.className = 'tunnel-dot tunnel-' + data.tunnel;
                lbl.className = 'tunnel-label tunnel-label-' + data.tunnel;
                lbl.textContent = labels[data.tunnel] || data.tunnel;
            }
            // Update auto mode toggles
            document.querySelectorAll('.auto-row[data-mode]').forEach(function(row) {
                var key = row.getAttribute('data-mode');
                var toggle = row.querySelector('.toggle');
                if (!toggle) return;
                var isRunning = data.tasks.some(function(t) { return t.endsWith('_' + key); });
                if (isRunning) toggle.classList.add('on');
                else toggle.classList.remove('on');
            });
        })
        .catch(function() {});
}
refreshStatus();
setInterval(refreshStatus, 3000);

function getSelectedDevices() {
    var checkboxes = document.querySelectorAll('input[name="device_select"]:checked');
    if (checkboxes.length > 0) {
        return Array.prototype.map.call(checkboxes, function(cb) { return cb.value; });
    }
    // Single device (no selector shown) â€” read from device card
    var card = document.querySelector('.device-card[data-device]');
    if (card) return [card.getAttribute('data-device')];
    // Last resort: read from first action form
    var input = document.querySelector('.device-form input[name="device"]');
    return input ? [input.value] : [];
}
function updateDeviceForms() {
    var devices = getSelectedDevices();
    var val = devices.join(',');
    document.querySelectorAll('.device-form').forEach(function(form) {
        var input = form.querySelector('input[name="device"]');
        if (input) input.value = val;
    });
}
document.addEventListener('DOMContentLoaded', updateDeviceForms);

function toggleAutoMode(modeKey) {
    var row = document.querySelector('.auto-row[data-mode="' + modeKey + '"]');
    if (!row) return;
    var toggle = row.querySelector('.toggle');
    var isRunning = toggle && toggle.classList.contains('on');
    var body;
    var url;
    if (isRunning) {
        url = '/tasks/stop-mode';
        body = 'mode_key=' + encodeURIComponent(modeKey);
    } else {
        url = '/tasks/start';
        var devices = getSelectedDevices();
        body = 'device=' + encodeURIComponent(devices.join(','))
             + '&task_name=' + encodeURIComponent(modeKey)
             + '&task_type=auto';
    }
    // Optimistic toggle
    if (toggle) toggle.classList.toggle('on');
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: body
    }).catch(function() {});
}

function copyAccessUrl(btn, url) {
    navigator.clipboard.writeText(url).then(function() {
        var orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(function() { btn.textContent = orig; }, 1500);
    }).catch(function() {});
}

function showQr(url) {
    var overlay = document.getElementById('qr-overlay');
    var img = document.getElementById('qr-img');
    var title = document.getElementById('qr-title');
    title.textContent = url;
    img.src = '/api/qr?url=' + encodeURIComponent(url);
    overlay.classList.add('visible');
}
function closeQr() {
    document.getElementById('qr-overlay').classList.remove('visible');
}

function downloadBugReport() {
    fetch('/api/bug-report', {method: 'POST'})
        .then(function(r) { return r.blob().then(function(b) { return {blob: b, r: r}; }); })
        .then(function(obj) {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(obj.blob);
            var cd = obj.r.headers.get('Content-Disposition') || '';
            var m = cd.match(/filename="?([^"]+)"?/);
            a.download = m ? m[1] : 'pacbot_bugreport.zip';
            a.click();
            URL.revokeObjectURL(a.href);
        }).catch(function() {});
}

</script>
{% endblock %}
