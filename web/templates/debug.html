{% extends "base.html" %}
{% block title_suffix %} - Debug{% endblock %}

{% block content %}

<div class="section-header">Screenshot</div>
<div class="action-grid">
{% for dev in devices %}
<button class="action-chip action-chip-debug" onclick="takeScreenshot('{{ dev.id }}')">Screenshot {{ dev.name }}</button>
{% endfor %}
</div>


<div class="section-header">Debug Actions</div>
<div class="action-grid">
{% for name in debug_actions %}
<form method="post" action="/tasks/start" class="device-form">
    <input type="hidden" name="device" value="{{ devices|map(attribute='id')|join(',') }}">
    <input type="hidden" name="task_name" value="{{ name }}">
    <input type="hidden" name="task_type" value="oneshot">
    <button type="submit" class="action-chip action-chip-debug">{{ name }}</button>
</form>
{% endfor %}
</div>

<!-- Running Tasks -->
{% if tasks %}
<div class="section-header" style="margin-top:24px">Running</div>
<div class="running-list">
{% for task in tasks %}
<div class="running-row">
    <span class="running-name">{{ task }}</span>
    <form method="post" action="/tasks/stop" class="inline-form">
        <input type="hidden" name="task_key" value="{{ task }}">
        <button type="submit" class="running-stop">&times;</button>
    </form>
</div>
{% endfor %}
</div>
{% endif %}

<!-- Logs -->
<div class="section-header" style="margin-top:24px">Logs</div>
<div class="log-controls">
    <button class="btn btn-sm" onclick="refreshLogs()">Refresh</button>
    <label class="setting-row" style="border:none; padding:0">
        <input type="checkbox" id="auto-scroll" checked>
        Auto-scroll
    </label>
</div>
<div class="log-viewer" id="log-viewer">
{% for line in log_lines %}
<div class="log-line">{{ line }}</div>
{% endfor %}
</div>

{% endblock %}

{% block scripts %}
<script>
function updateDeviceForms() {
    var checkboxes = document.querySelectorAll('input[name="device_select"]:checked');
    var devices;
    if (checkboxes.length > 0) {
        devices = Array.prototype.map.call(checkboxes, function(cb) { return cb.value; });
    } else {
        var input = document.querySelector('.device-form input[name="device"]');
        devices = input ? [input.value] : [];
    }
    var val = devices.join(',');
    document.querySelectorAll('.device-form').forEach(function(form) {
        var input = form.querySelector('input[name="device"]');
        if (input) input.value = val;
    });
}

function takeScreenshot(device) {
    window.location.href = '/api/screenshot?device=' + encodeURIComponent(device) + '&download=1';
}

var logViewer = document.getElementById('log-viewer');

function scrollToBottom() {
    if (document.getElementById('auto-scroll').checked) {
        logViewer.scrollTop = logViewer.scrollHeight;
    }
}

function refreshLogs() {
    fetch('/api/logs')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            logViewer.textContent = '';
            data.lines.forEach(function(line) {
                var div = document.createElement('div');
                div.className = 'log-line';
                div.textContent = line;
                logViewer.appendChild(div);
            });
            scrollToBottom();
        })
        .catch(function() {});
}

setInterval(refreshLogs, 5000);

document.addEventListener('DOMContentLoaded', function() {
    updateDeviceForms();
    scrollToBottom();
});
</script>
{% endblock %}
