{% extends "base.html" %}
{% block title_suffix %} - Debug{% endblock %}

{% block content %}

<div class="section-header">Screenshot</div>
<div class="action-grid">
{% for dev in devices %}
<button class="action-chip action-chip-debug" onclick="takeScreenshot('{{ dev.id }}')">Screenshot {{ dev.name }}</button>
{% endfor %}
</div>


<div class="section-header">Debug Actions</div>
<div class="action-grid">
{% for name in debug_actions %}
<form method="post" action="/tasks/start" class="device-form">
    <input type="hidden" name="device" value="{{ devices|map(attribute='id')|join(',') }}">
    <input type="hidden" name="task_name" value="{{ name }}">
    <input type="hidden" name="task_type" value="oneshot">
    <button type="submit" class="action-chip action-chip-debug">{{ name }}</button>
</form>
{% endfor %}
</div>

<div class="section-header" style="margin-top:24px">Reports</div>
<div class="action-grid">
<button class="action-chip action-chip-debug" id="bug-report-btn" onclick="downloadBugReport()">Bug Report</button>
<button class="action-chip action-chip-debug" id="upload-logs-btn" onclick="uploadLogs()">Upload Logs</button>
</div>

<!-- Running Tasks -->
{% if tasks %}
<div class="section-header" style="margin-top:24px">Running</div>
<div class="running-list">
{% for task in tasks %}
<div class="running-row">
    <span class="running-name">{{ task }}</span>
    <form method="post" action="/tasks/stop" class="inline-form">
        <input type="hidden" name="task_key" value="{{ task }}">
        <button type="submit" class="running-stop">&times;</button>
    </form>
</div>
{% endfor %}
</div>
{% endif %}

<!-- Logs -->
<div class="section-header" style="margin-top:24px">Logs</div>
<div class="log-controls">
    <button class="btn btn-sm" onclick="refreshLogs()">Refresh</button>
    <label class="setting-row" style="border:none; padding:0">
        <input type="checkbox" id="auto-scroll" checked>
        Auto-scroll
    </label>
</div>
<div class="log-viewer" id="log-viewer">
{% for line in log_lines %}
<div class="log-line">{{ line }}</div>
{% endfor %}
</div>

{% endblock %}

{% block scripts %}
<script>
function updateDeviceForms() {
    var checkboxes = document.querySelectorAll('input[name="device_select"]:checked');
    var devices;
    if (checkboxes.length > 0) {
        devices = Array.prototype.map.call(checkboxes, function(cb) { return cb.value; });
    } else {
        var input = document.querySelector('.device-form input[name="device"]');
        devices = input ? [input.value] : [];
    }
    var val = devices.join(',');
    document.querySelectorAll('.device-form').forEach(function(form) {
        var input = form.querySelector('input[name="device"]');
        if (input) input.value = val;
    });
}

function takeScreenshot(device) {
    window.location.href = '/api/screenshot?device=' + encodeURIComponent(device) + '&download=1';
}

function downloadBugReport() {
    var btn = document.getElementById('bug-report-btn');
    btn.textContent = 'Generating...';
    btn.disabled = true;
    fetch('/api/bug-report', {method: 'POST'})
        .then(function(r) {
            if (!r.ok) throw new Error('Failed');
            var filename = 'bug_report.zip';
            var cd = r.headers.get('Content-Disposition');
            if (cd) {
                var m = cd.match(/filename="?([^"]+)"?/);
                if (m) filename = m[1];
            }
            return r.blob().then(function(blob) { return {blob: blob, filename: filename}; });
        })
        .then(function(data) {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(data.blob);
            a.download = data.filename;
            a.click();
            URL.revokeObjectURL(a.href);
            btn.textContent = 'Downloaded!';
            btn.style.borderColor = '#4cff8e';
            setTimeout(function() {
                btn.textContent = 'Bug Report';
                btn.disabled = false;
                btn.style.borderColor = '';
            }, 3000);
        })
        .catch(function() {
            btn.textContent = 'Error';
            btn.style.borderColor = '#ff6464';
            btn.disabled = false;
            setTimeout(function() {
                btn.textContent = 'Bug Report';
                btn.style.borderColor = '';
            }, 3000);
        });
}

function uploadLogs() {
    var btn = document.getElementById('upload-logs-btn');
    btn.textContent = 'Uploading...';
    btn.disabled = true;
    fetch('/api/upload-logs', {method: 'POST'})
        .then(function(r) { return r.json(); })
        .then(function(data) {
            btn.textContent = data.ok ? 'Uploaded!' : 'Failed';
            btn.style.borderColor = data.ok ? '#4cff8e' : '#ff6464';
            setTimeout(function() {
                btn.textContent = 'Upload Logs';
                btn.disabled = false;
                btn.style.borderColor = '';
            }, 3000);
        })
        .catch(function() {
            btn.textContent = 'Error';
            btn.disabled = false;
            setTimeout(function() { btn.textContent = 'Upload Logs'; }, 3000);
        });
}

var logViewer = document.getElementById('log-viewer');

function scrollToBottom() {
    if (document.getElementById('auto-scroll').checked) {
        logViewer.scrollTop = logViewer.scrollHeight;
    }
}

function refreshLogs() {
    fetch('/api/logs')
        .then(function(r) { return r.json(); })
        .then(function(data) {
            logViewer.textContent = '';
            data.lines.forEach(function(line) {
                var div = document.createElement('div');
                div.className = 'log-line';
                div.textContent = line;
                logViewer.appendChild(div);
            });
            scrollToBottom();
        })
        .catch(function() {});
}

setInterval(refreshLogs, 5000);

document.addEventListener('DOMContentLoaded', function() {
    updateDeviceForms();
    scrollToBottom();
});
</script>
{% endblock %}
