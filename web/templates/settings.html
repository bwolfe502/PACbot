{% extends "base.html" %}
{% block title_suffix %} - Settings{% endblock %}

{% block content %}
<h1>Settings</h1>

<!-- Device Tabs -->
{% if all_devices %}
<div class="settings-tabs">
    <a href="/settings" class="settings-tab active">Global</a>
    {% for dev in all_devices %}
    <a href="/settings/device/{{ dev.id }}" class="settings-tab">{{ dev.name }}</a>
    {% endfor %}
</div>
{% endif %}

<form method="post" action="/settings">
    <!-- General -->
    <div class="card">
        <h3>General</h3>
        <label class="setting-row">
            <input type="checkbox" name="auto_heal" {% if settings.auto_heal %}checked{% endif %}>
            Auto Heal
        </label>
        <label class="setting-row">
            <input type="checkbox" name="verbose_logging" {% if settings.verbose_logging %}checked{% endif %}>
            Verbose Logging
        </label>
        <label class="setting-row">
            <input type="checkbox" name="web_dashboard" {% if settings.web_dashboard %}checked{% endif %}>
            Web Dashboard Enabled
        </label>
    </div>

    <!-- Remote Access -->
    <div class="card">
        <h3>Remote Access</h3>
        <label class="setting-row">
            <input type="checkbox" name="remote_access" {% if settings.remote_access %}checked{% endif %}>
            Enable Remote Access
        </label>
        <p style="color:#667;font-size:12px;padding-top:6px;margin:0">Requires restart to take effect.</p>
        <label class="setting-row" style="margin-top:12px">
            <input type="checkbox" name="auto_upload_logs" {% if settings.auto_upload_logs %}checked{% endif %}>
            Auto-Upload Bug Reports
        </label>
        <label class="setting-row indent">
            <input type="number" name="upload_interval_hours" class="input-sm"
                   min="1" max="168" value="{{ settings.upload_interval_hours }}">
            <span class="unit">hours</span>
        </label>
        <p style="color:#667;font-size:12px;padding-top:6px;margin:0">Periodically uploads logs and debug data for troubleshooting. Requires restart.</p>
    </div>

    <!-- Auto Quest -->
    <div class="card">
        <h3>Auto Quest</h3>
        <label class="setting-row">
            <input type="checkbox" name="eg_rally_own" {% if settings.eg_rally_own %}checked{% endif %}>
            Rally Own Evil Guard
        </label>
        <label class="setting-row">
            <input type="checkbox" name="titan_rally_own" {% if settings.titan_rally_own %}checked{% endif %}>
            Rally Own Titans
        </label>
        <label class="setting-row">
            <input type="checkbox" name="gather_enabled" {% if settings.gather_enabled %}checked{% endif %}>
            Gather Gold
        </label>
        <div class="setting-row indent">
            <label>Mine Level:
                <select name="gather_mine_level" class="select-sm">
                    {% for lv in [4, 5, 6] %}
                    <option value="{{ lv }}" {% if settings.gather_mine_level == lv %}selected{% endif %}>{{ lv }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>
        <div class="setting-row indent">
            <label>Max Troops:
                <select name="gather_max_troops" class="select-sm">
                    {% for n in [1, 2, 3, 4, 5] %}
                    <option value="{{ n }}" {% if settings.gather_max_troops == n %}selected{% endif %}>{{ n }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>
        <label class="setting-row">
            <input type="checkbox" name="tower_quest_enabled" {% if settings.tower_quest_enabled %}checked{% endif %}>
            Tower Quest <span style="color:#888;font-size:0.8em">(mark tower with target marker first)</span>
        </label>
    </div>

    <!-- AP Restoration -->
    <div class="card">
        <h3>AP Restoration</h3>
        <label class="setting-row">
            <input type="checkbox" name="auto_restore_ap" {% if settings.auto_restore_ap %}checked{% endif %}>
            Auto Restore AP
        </label>
        <label class="setting-row indent">
            <input type="checkbox" name="ap_use_free" {% if settings.ap_use_free %}checked{% endif %}>
            Use Free Restores
        </label>
        <label class="setting-row indent">
            <input type="checkbox" name="ap_use_potions" {% if settings.ap_use_potions %}checked{% endif %}>
            Use Potions
        </label>
        <label class="setting-row indent">
            <input type="checkbox" name="ap_allow_large_potions" {% if settings.ap_allow_large_potions %}checked{% endif %}>
            Allow Large Potions
        </label>
        <label class="setting-row indent">
            <input type="checkbox" name="ap_use_gems" {% if settings.ap_use_gems %}checked{% endif %}>
            Use Gems
        </label>
        <div class="setting-row indent">
            <label>Gem Limit:
                <input type="number" name="ap_gem_limit" value="{{ settings.ap_gem_limit }}"
                       min="0" max="3500" class="input-sm">
            </label>
        </div>
    </div>

    <!-- Troops & Timing -->
    <div class="card">
        <h3>Troops & Timing</h3>
        <div class="setting-row">
            <label>Min Troops:
                <input type="number" name="min_troops" value="{{ settings.min_troops }}"
                       min="0" max="5" class="input-sm">
            </label>
        </div>
        <div class="setting-row">
            <label>Randomize +/-:
                <input type="number" name="variation" value="{{ settings.variation }}"
                       min="0" class="input-sm">
                <span class="unit">seconds</span>
            </label>
        </div>
    </div>

    <!-- Intervals -->
    <div class="card">
        <h3>Intervals</h3>
        <div class="setting-row">
            <label>Titan:
                <input type="number" name="titan_interval" value="{{ settings.titan_interval }}"
                       min="1" class="input-sm">
                <span class="unit">s</span>
            </label>
        </div>
        <div class="setting-row">
            <label>Groot:
                <input type="number" name="groot_interval" value="{{ settings.groot_interval }}"
                       min="1" class="input-sm">
                <span class="unit">s</span>
            </label>
        </div>
        <div class="setting-row">
            <label>Reinforce:
                <input type="number" name="reinforce_interval" value="{{ settings.reinforce_interval }}"
                       min="1" class="input-sm">
                <span class="unit">s</span>
            </label>
        </div>
        <div class="setting-row">
            <label>Pass:
                <input type="number" name="pass_interval" value="{{ settings.pass_interval }}"
                       min="1" class="input-sm">
                <span class="unit">s</span>
            </label>
        </div>
        <div class="setting-row">
            <label>Mithril:
                <input type="number" name="mithril_interval" value="{{ settings.mithril_interval }}"
                       min="1" class="input-sm">
                <span class="unit">min</span>
            </label>
        </div>
    </div>

    <!-- Mode & Teams -->
    <div class="card">
        <h3>Mode & Teams</h3>
        <div class="setting-row">
            <label>Pass Mode:
                <select name="pass_mode" class="select-sm">
                    <option value="Rally Joiner" {% if settings.pass_mode == 'Rally Joiner' %}selected{% endif %}>Rally Joiner</option>
                    <option value="Rally Starter" {% if settings.pass_mode == 'Rally Starter' %}selected{% endif %}>Rally Starter</option>
                </select>
            </label>
        </div>
        <div class="setting-row">
            <label>Game Mode:
                <select name="mode" class="select-sm">
                    <option value="bl" {% if settings.mode == 'bl' %}selected{% endif %}>Broken Lands</option>
                    <option value="rw" {% if settings.mode == 'rw' %}selected{% endif %}>Home Server</option>
                </select>
            </label>
        </div>
        <div class="setting-row">
            <label>My Team:
                <select name="my_team" class="select-sm">
                    {% for color in ['yellow', 'red', 'blue', 'green'] %}
                    <option value="{{ color }}" {% if settings.my_team == color %}selected{% endif %}>{{ color|capitalize }}</option>
                    {% endfor %}
                </select>
            </label>
        </div>
        <!-- Enemy teams auto-derived: all teams except my_team -->
    </div>

    <!-- Device Troops -->
    <div class="card">
        <h3>Device Troops</h3>
        {% if device_troops %}
        {% for dev_id, count in device_troops.items() %}
        <div class="setting-row">
            <label>{{ dev_id }}:
                <input type="number" name="dt_{{ dev_id }}" value="{{ count }}"
                       min="1" max="5" class="input-sm">
            </label>
        </div>
        {% endfor %}
        {% else %}
        <p class="muted">No devices detected yet.</p>
        {% endif %}
    </div>

    <button type="submit" class="btn btn-primary btn-full">Save Settings</button>
</form>

<a href="/territory" class="btn btn-full" style="display:block;text-align:center;margin-top:12px;background:#2a2a4a;color:#aab;border:1px solid #3a3a5a;">Territory Grid</a>
{% endblock %}
